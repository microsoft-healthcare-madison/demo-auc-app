
<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <meta name="theme-color" content="#4F7DC9">
  <meta charset="UTF-8">
  <title>Embed an External AUC Guideline Consultation App Into an EHR</title>
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro:400|Roboto:400,300,400italic,500,700|Roboto+Mono">
  <link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://storage.googleapis.com/codelab-elements/codelab-elements.css">
  <style>
    .success {
      color: #1e8e3e;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  <google-codelab-analytics gaid="UA-49880327-14"></google-codelab-analytics>
  <google-codelab codelab-gaid=""
                  id="docs"
                  title="Embed an External AUC Guideline Consultation App Into an EHR"
                  environment="web"
                  feedback-link="https://github.com/microsoft-healthcare-madison/demo-auc-app/issues">
    
      <google-codelab-step label="Introduction" duration="10">
        <h2 is-upgraded>Welcome, student!</h2>
<p>This codelab is intended to teach you about the <a href="http://www.hl7.org/fhir/smart-app-launch/" target="_blank">SMART launch framework</a>, <a href="https://cds-hooks.org/" target="_blank">CDS Hooks</a>, and <a href="https://github.com/smart-on-fhir/smart-web-messaging" target="_blank">SMART Web Messaging</a> by walking you through a coding exercise that uses those technologies.</p>
<h3 is-upgraded>Profile Audience</h3>
<p>This guide is intended for programmers who wish to <em>learn by doing</em>.  You should already have a working knowledge of web programing, access to a development machine, and about 2 to 5 total hours to dedicate to completing the whole codelab.  Your completion time will vary based on your familiarity with Javascript, web programming concepts, and the API in general.</p>
<h3 is-upgraded>Prerequisites</h3>
<p>This guide assumes you are already familiar with javascript and are comfortable with web programming concepts.  It also helps to know the basics of <code>git</code>, but there will be example commands throughout for convenience.  The provided initial codebase uses <code>javascript</code>, <code>node</code>, <code>nvm</code>, <code>npm</code>, and <code>express</code> - so some prior experience with those tools will be helpful, but not required.  JavaScript in the browser and in Node.js, and the express Web framework for Node.js</p>
<h3 is-upgraded>Contributing</h3>
<p>As always, you are free to re-write entire portions of the code in whatever framework you like (and please feel free to share your work with us)!</p>
<p>The codelab has a wiki which should help you decide how to best contribute:<br><a href="https://github.com/microsoft-healthcare-madison/demo-auc-app/wiki" target="_blank">https://github.com/microsoft-healthcare-madison/demo-auc-app/wiki</a></p>
<p>Also, take notice of the <a href="https://github.com/microsoft-healthcare-madison/demo-auc-app/issues" target="_blank">Report a mistake</a> link that appears in the lower left corner of each page!</p>
<h3 is-upgraded>Major Milestones</h3>
<p>You will start with an already-implemented form-entry app that evaluates the appropriateness of a potential advanced imaging order and displays a rating of either <code>appropriate</code>, <code>not-appropriate</code>, or <code>no-guidelines-apply</code>.</p>
<ul>
<li>v1: Make the app SMART-launch capable, enabling an EHR to launch it.</li>
<li>v2: Create a CDS Hooks service to evaluate a <em>draft</em> order in an EHR, and show a link to the SMART app.</li>
<li>v3: Enable the SMART app to update the draft order inside the EHR.</li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="PAMA" duration="20">
        <h2 is-upgraded>PAMA - Protecting Access to Medicare Act of 2014</h2>
<aside class="warning"><p><em>&#34;If we in the United States could lower the prices and per-capita volumes of our CT scans, MRIs, and just the top 25 high-volume-high-price surgical procedures to those of the Netherlands, for example, we would see savings of about $425 per capita, or a total of $137 billion.&#34;</em></p>
<p><a href="https://en.wikipedia.org/wiki/Ezekiel_Emanuel" target="_blank"><strong>Ezekiel Emanuel</strong></a><strong>, on an </strong><a href="https://jamanetwork.com/journals/jama/article-abstract/2674671" target="_blank"><strong>article published in JAMA, March 2018</strong></a></p>
</aside>
<h3 is-upgraded>Skip Ahead</h3>
<p>This section has <em>lots</em> of background which explains <em>why</em> the <a href="https://www.cms.gov/Medicare/Medicare-Fee-for-Service-Payment/ClinicalLabFeeSched/PAMA-Regulations" target="_blank">PAMA</a> imaging use case was chosen for this exercise.  If you aren&#39;t interested in PAMA, and are here purely to learn the technology, you can skip ahead to the next section.  However, it might help to take at least <em>a few</em> minutes to skim this material, just to get the gist of what problem is being solved.</p>
<h3 is-upgraded><strong>Warp</strong> Ahead</h3>
<p>If you already have a good grasp of the SMART launch process, and you would like to do a lot more than <em>skip</em> ahead, you can <strong>warp</strong> ahead and begin the process at CDS Hooks implementation by checking out the code at <code>v2.0</code> in the repo and advancing to the section called <strong>Write a CDS Hooks Service</strong> in this codelab.</p>
<p>There&#39;s another git tag, <code>v3.0</code>, for the <strong>final</strong> solution.  Check out this version of the code if you just want to play with a working copy of the app.  However, if you&#39;re here to learn, it is recommended that you find time to do the full codelab.</p>
<h2 is-upgraded>PAMA Imaging</h2>
<p>New PAMA imaging requirements are taking effect, starting on January 1st, 2020.  The American College of Radiology has put out some very helpful media to explain why this is important.</p>
<ul>
<li><a href="https://www.acr.org/-/media/ACR/Files/Clinical-Resources/Clinical-Decision-Support/RSCAN-PAMA_flyer.pdf" target="_blank">https://www.acr.org/-/media/ACR/Files/Clinical-Resources/Clinical-Decision-Support/RSCAN-PAMA_flyer.pdf</a></li>
<li><a href="https://www.acr.org/Clinical-Resources/Clinical-Decision-Support" target="_blank">https://www.acr.org/Clinical-Resources/Clinical-Decision-Support</a></li>
</ul>
<h3 is-upgraded>Timeline</h3>
<table>
<tr></tr>
<tr><td colspan="1" rowspan="1"><p>2020</p>
</td><td colspan="1" rowspan="1"><p>Starting in 2020, providers in the US who order diagnostic advanced imaging (CT, MRI, nuclear medicine, and PET scans) will need to provide <em>evidence</em> that they have consulted <em>best practice guidelines</em> for appropriate use of that technology <em>while they are still at the point of order entry</em>.</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>2021</p>
</td><td colspan="1" rowspan="1"><p>Failure to submit a claim for imaging that has this evidence, starting in 2021, may <em>prevent</em> reimbursement (for Medicare part B claims) for furnishing providers (who are typically radiologists).</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>2022</p>
</td><td colspan="1" rowspan="1"><p>Ordering providers who have a <em>consistently</em> poor history of ordering &#34;low value&#34; diagnosic imaging may then be subject to mandatory prior authorization before placing image orders for Medicare patients starting in 2022.  Some of those rules are TBD, depending on how the first two years go, though.</p>
</td></tr>
</table>
<h3 is-upgraded>Apropriate Use Criteria (AUC)</h3>
<p>In short, for software to determine whether an imaging technique is <em>apropriate</em> or not for a given diagnosis, several groups of specialists have been developing <em>apropriate use criteria</em> and publishing that criteria for the industry to adopt into the EHR workflow.  These AUC are regularly improved, updated, and re-published.</p>
<h3 is-upgraded>Provider Led Entities (PLE)</h3>
<p>The groups of experts and specialists who decide what is and isn&#39;t appropriate are called <em>Provider Led Entities</em>.  They develop the AUC out in the open and publish it reqularly for consumption by software vendors who provide CDS.</p>
<h3 is-upgraded>Qualified CDS Mechanisms (QCDSM)</h3>
<p>The software providers who use this criteria, the QCDSM vendors, must provide access to best practice guidelines for a wide spectrum of medical care areas.  For PAMA imaging, we are interested in the radiology imaging AUC and we have prepared a simple example of QCDSM guideline consultation software.  However, a QCDSM must be able to use more than one published set of AUC in their software, and have a method of updating their AUC periodically (See pages 4 and 5 <a href="https://www.cms.gov/Outreach-and-Education/Medicare-Learning-Network-MLN/MLNProducts/Downloads/AUCDiagnosticImaging-909377.pdf" target="_blank">here</a> for details).  As such, the QCDSM software can be quite complex, and is often implemented as a stand-alone web service.</p>
<h2 class="faq" is-upgraded>Frequently Asked Questions</h2>
<h3 is-upgraded>Why are <em>CDS Hooks</em> important for PAMA?</h3>
<aside class="special"><p>To satisfy a radiologist&#39;s claim to CMS, the original order must include evidence that guidelines were consulted at the point of order entry (by the <em>ordering provider</em>).  This means that, while the ordering provider is still using the EHR, they must also be consulting guidelines for appropriate use.  By using <em>CDS Hooks</em>, the EHR can consult a guideline service automatically, as soon as it&#39;s relevant – sharing results or a link to the guideline app if further interaction is needed.<br></p>
</aside>
<h3 is-upgraded>Why is <em>SMART Web Messaging</em> important for PAMA?</h3>
<aside class="special"><p>Because the logic to determine <em>when</em> a service is or isn&#39;t appropriate can be very complex, this logic is often implemented in stand-alone web-based applications.  To enable those applications to <strong>update</strong> the current <em>draft</em> order, we need SMART Web Messaging.  With SMART Web Messaging, we can easily and securely send data and actions <em>back</em> into the EHR.</p>
</aside>


      </google-codelab-step>
    
      <google-codelab-step label="Example App" duration="2">
        <p>You are provided with a very simple, but working, guideline consultation app.  In PAMA parlance, this would be software from a Qualified CDS Mechanism, or a QCDSM.</p>
<p>Below is an embedded version of the app in its original state.  The idea is that clinicians would use this tool alongside their EHR when consulting guidelines.  The app would provide them some kind of evidence code which they could copy and paste back into the EHR before signing an order.</p>
<p>Feel free to explore the app to get a sense of how it works.  Any non-empty username and password will allow you to use the app - the login is totally fake.</p>
<iframe class="embedded-iframe" src="https://glitch.com/embed/#!/embed/jewel-chevre?path=package.json&previewSize=100"></iframe>


      </google-codelab-step>
    
      <google-codelab-step label="Exercise Outline" duration="5">
        <h2 is-upgraded>SMART Launch</h2>
<p>You will add SMART launch capabilities to the app, allowing it to be launched by the EHR and to receive EHR data directly through the SMART launch client.</p>
<h2 is-upgraded>CDS Hooks</h2>
<p>Once the app is capable of a SMART launch, you will write a CDS Hooks service to alert ordering providers when they have made an order selection that is outside of guidelines.  The alert will give them a helpful link to click on, which will launch the app <em>within the EHR</em>.  The app will read context from the EHR and use that to pre-populate the appropriate fields in its form, saving the clinician time and mental effort.</p>
<h3 is-upgraded>Example Cards</h3>
<p class="image-container"><img alt="example-cards" src="img/1fe46a51076bd238.png"></p>
<h2 is-upgraded>SMART Web Messaging</h2>
<p>Finally, a new button will be added in the app that will be able to update the draft order items with the current selection.  Upon update, evidence of guideline consultation will be attached to the order, before closing the app, returning the user to the order entry screen in the EHR.</p>
<p><strong>TODO</strong>: insert an image of the embedded app.</p>
<h2 class="faq" is-upgraded>Frequently Asked Questions</h2>
<h3 is-upgraded>Which EHRs currently support the technologies required to enable these services?</h3>
<aside class="special"><p>Currently, very <em>few</em> EHR vendors have implemented the required CDS Hooks to enable this (<em>T-Systems is a notable exception</em>).  Cerner has committed to doing this, though, and it&#39;s not a matter of if, but of when.  Epic is also ‘working on it.&#39;</p>
<p>While this may seem like a negative thing, the other way to see the situation is that any QCDSM vendor who is <em>ready</em> with product when CDS Hooks <em>does</em> become widespread will have the mover&#39;s advantage.  Also, there is currently relatively low pressure for an EHR vendor to get ‘caught up&#39; with competitors (but that should be changing rapidly in 2020).</p>
<p>In other words, there is still time to get ready!</p>
<p>For a list of vendors who support CDS Hooks, please refer to this:<br><a href="https://github.com/argonautproject/cds-hooks/wiki/Readiness-and-Testing-Matrix" target="_blank">https://github.com/argonautproject/cds-hooks/wiki/Readiness-and-Testing-Matrix</a></p>
</aside>


      </google-codelab-step>
    
      <google-codelab-step label="Prerequisites" duration="5">
        <p>You must have a development machine with the following:</p>
<table>
<tr></tr>
<tr><td colspan="1" rowspan="1"><p><code>git</code></p>
</td><td colspan="1" rowspan="1"><p><a href="https://git-scm.com/downloads" target="_blank">Download</a></p>
</td><td colspan="1" rowspan="1"><p>Needed to check out the initial codebase.</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p><code>nvm</code></p>
</td><td colspan="1" rowspan="1"><p><a href="https://github.com/nvm-sh/nvm" target="_blank">Download</a></p>
</td><td colspan="1" rowspan="1"><p>RECOMMENDED to manage different installed versions of <code>node</code>.</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p><code>nvm-windows</code></p>
</td><td colspan="1" rowspan="1"><p><a href="https://github.com/coreybutler/nvm-windows/releases" target="_blank">Download</a></p>
</td><td colspan="1" rowspan="1"><p>WINDOWS version of <code>nvm</code>.</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p><code>npm</code></p>
</td><td colspan="1" rowspan="1"><p><a href="https://nodejs.org/en/download/" target="_blank">Download</a></p>
</td><td colspan="1" rowspan="1"><p>Needed to install the server dependencies and run it locally.</p>
</td></tr>
</table>
<aside class="special"><p>This guide was developed using <code>node v12.13.1</code>, which is the current <a href="https://en.wikipedia.org/wiki/Long-term_support" target="_blank">LTS</a> release.</p>
</aside>
<h2 is-upgraded>Links</h2>
<ul>
<li><a href="https://www.sitepoint.com/quick-tip-multiple-versions-node-nvm/" target="_blank">https://www.sitepoint.com/quick-tip-multiple-versions-node-nvm/</a></li>
</ul>
<h2 class="faq" is-upgraded>Frequently Asked Questions</h2>
<ul class="faq">
<li><a href="https://stackoverflow.com/questions/16904658/node-version-manager-install-nvm-command-not-found" target="_blank">https://stackoverflow.com/questions/16904658/node-version-manager-install-nvm-command-not-found</a></li>
<li><a href="https://stackoverflow.com/questions/9755841/how-can-i-change-the-version-of-npm-using-nvm" target="_blank">https://stackoverflow.com/questions/9755841/how-can-i-change-the-version-of-npm-using-nvm</a></li>
<li><a href="https://stackoverflow.com/questions/34810526/how-to-properly-upgrade-node-using-nvm" target="_blank">https://stackoverflow.com/questions/34810526/how-to-properly-upgrade-node-using-nvm</a></li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="Getting Started" duration="15">
        <h2 is-upgraded>Code Repository</h2>
<p>The companion source code for this codelab is currently at:<br><a href="https://github.com/microsoft-healthcare-madison/demo-auc-app" target="_blank">https://github.com/microsoft-healthcare-madison/demo-auc-app</a></p>
<h2 is-upgraded>Clone v1.0</h2>
<p>To begin this codelab, begin by cloning the repository <em>at</em> the initial version, which is <code>v1.0</code>.</p>
<pre><code>mkdir ~/codelab
cd ~/codelab
git clone --branch v1.0 git@github.com:microsoft-healthcare-madison/demo-auc-app.git
cd demo-auc-app
npm install
</code></pre>
<p>The demo app is now ready to be started using this command:</p>
<pre><code>npm run demo
</code></pre>
<p>To view the app, visit this URL: <a href="http://localhost:3001" target="_blank">http://localhost:3001</a></p>
<h3 is-upgraded>Login</h3>
<p>You can use any non-empty username and password to log in to the app.</p>
<p class="image-container"><img alt="login" src="img/5676161ebc2cd176.png"></p>
<h2 is-upgraded>Exercises</h2>
<p>To get you familiar with the app and how it works, please launch the app and use it to rate the following combinations of demographics.</p>
<table>
<tr></tr>
<tr><td colspan="1" rowspan="1"><p>4</p>
</td><td colspan="1" rowspan="1"><p>male</p>
</td><td colspan="1" rowspan="1"><p>lower back pain</p>
</td><td colspan="1" rowspan="1"><p>lumbar spine CT</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>98</p>
</td><td colspan="1" rowspan="1"><p>female</p>
</td><td colspan="1" rowspan="1"><p>congenital heart disease</p>
</td><td colspan="1" rowspan="1"><p>cardiac mri</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>29</p>
</td><td colspan="1" rowspan="1"><p>female</p>
</td><td colspan="1" rowspan="1"><p>headache</p>
</td><td colspan="1" rowspan="1"><p>ct scan without contrast materials</p>
</td></tr>
</table>
<p>Be sure to <em>also</em> try any of the above tests, but with a missing field.  The app should require you to enter a value for each field (without doing any <em>additional</em> sanity checking, though).</p>
<h2 class="faq" is-upgraded>Frequently Asked Questions</h2>
<h3 is-upgraded>I see this when trying to run the demo: <code>npm ERR! code ENOENT</code></h3>
<aside class="warning"><p>Be sure you run <code>npm install</code> inside the <code>demo-auc-app</code> directory that you cloned from git.  After that completes, <em>then</em> run <code>npm run demo</code> and visit <a href="http://localhost:3001" target="_blank">http://localhost:3001</a>.</p>
</aside>
<h3 is-upgraded>This site can&#39;t be reached.</h3>
<aside class="warning"><p>Be sure you ran <code>npm run demo</code> to start the local server before visiting the app at <a href="http://localhost:3001" target="_blank">http://localhost:3001</a>.</p>
</aside>
<h3 is-upgraded>This site can&#39;t provide a secure connection.</h3>
<aside class="warning"><p>You may have typed <code>https</code> instead of <code>http</code> in the URL.  You must use <code>http</code> for this.</p>
</aside>
<h3 is-upgraded>Error: listen EADDRINUSE: address already in use 0.0.0.0:8899</h3>
<aside class="warning"><p>It looks like you are attempting to run the server twice, or another service is already using that port number.  You can adjust the port number in your <code>package.json</code> file or stop the other running process holding a lock on that port.</p>
</aside>


      </google-codelab-step>
    
      <google-codelab-step label="Enable SMART Launch" duration="30">
        <h2 is-upgraded>Problem</h2>
<aside class="warning"><p>It is time consuming, error-prone, and frustrating for providers when they have to switch focus to a browser window outside of the EHR, remember a URL so they can launch an external app, remember their correct username and password, and then enter patient demographic information to perform some basic task.</p>
</aside>
<h2 is-upgraded>Solution</h2>
<aside class="special"><p><br>The SMART Launch Framework can dramatically improve the situation!<br><br>With the <a href="https://www.hl7.org/fhir/smart-app-launch/" target="_blank">SMART App Launch Framework</a>, the app will be able to securely read data from the EHR using the credentials of the clinician (through OAuth2 openid connect).  The provider will not need to remember a separate username and password to use the app anymore, and the app will be able to pre-load form fields using the available context in the EHR.<br><br>This will reduce user errors, save the user time, and spare them some frustrations.<br></p>
</aside>
<h2 is-upgraded>SMART Launch Documentation</h2>
<p>There is a very handy javascript library to enable easy configuration of SMART launches from the app.<br><a href="http://docs.smarthealthit.org/client-js/" target="_blank">http://docs.smarthealthit.org/client-js/</a></p>
<h3 is-upgraded>EXERCISE 1</h3>
<aside class="special"><p>Consult the link above, and create a <code>launch.html</code> endpoint.</p>
</aside>
<aside class="warning"><p><em>Confused?</em>  Part of the goal of this codelab is to get you familiar with using the documentation, so there will be minimal hand-holding throughout.</p>
</aside>
<p>Here are a couple of hints, in case this seems like a vague request.</p>
<ul>
<li>You may need to use the <code>npm</code> command to install the library.</li>
<li>Once installed, you will want to create an endpoint ‘page&#39; for use in a browser using the ‘As Library&#39; approach, rather than the ‘As Module&#39; approach.</li>
</ul>
<aside class="warning"><p>SPOILER<br>This is <em>one</em> possible solution.<br>IGNORE THIS: if you want the experience of implementing it yourself.<br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></p>
<pre><code>&lt;!-- launch.html --&gt;
&lt;!DOCTYPE html&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;script src=&#34;./node_modules/fhirclient/build/fhir-client.js&#34;&gt;&lt;/script&gt;
    &lt;script&gt;
    FHIR.oauth2.authorize({
      client_id: &#34;demo_auc_guideline_consultation_app&#34;,
      scope: &#34;patient/*.read openid profile&#34;
    });
    &lt;/script&gt;
  &lt;/head&gt;
  &lt;body&gt;Loading...&lt;/body&gt;
&lt;/html&gt;
</code></pre>
</aside>
<h3 is-upgraded>Scopes</h3>
<p>More information about scopes can be found here.<br><a href="http://www.hl7.org/fhir/smart-app-launch/scopes-and-launch-context/index.html" target="_blank">http://www.hl7.org/fhir/smart-app-launch/scopes-and-launch-context/index.html</a></p>
<h3 is-upgraded>EXERCISE 2</h3>
<aside class="special"><p>Make this <code>launch.html</code> page available on port <code>8899</code> on your local machine.</p>
</aside>
<p>Some hints:</p>
<ul>
<li>Consider using the <code>http-server</code> package for <code>npm</code> for a simple, easy to set-up, web server.</li>
<li>Add an entry to your <code>package.json</code> file so you can invoke <code>npm run launch</code> to run the launcher.</li>
</ul>
<aside class="warning"><p>SPOILER<br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>Add this to <code>package.json</code></p>
<pre><code>...
  &#34;scripts&#34;: {
    &#34;launch&#34;: &#34;http-server -p 8899 -c-1&#34;,
...
</code></pre>
<p>Run this on the command-line:</p>
<pre><code>npm install http-server
npm run launch
</code></pre>
</aside>
<h2 is-upgraded>Success!</h2>
<p>You should now be able to visit <a href="http://localhost:8899" target="_blank">http://localhost:8899</a> to have it launch the app, bypassing the login screen.</p>


      </google-codelab-step>
    
      <google-codelab-step label="Test SMART Launch" duration="5">
        <h2 is-upgraded>The SMART App Launcher</h2>
<p>To test the new launch endpoint, we can use a free, open source tool called the SMART App Launcher.<br><a href="http://launch.smarthealthit.org/" target="_blank">http://launch.smarthealthit.org/</a></p>
<h3 is-upgraded>EXERCISE</h3>
<aside class="special"><p>Visit the site and enter the path to your <code>launch.html</code> endpoint.  Click the green Launch App button to test.</p>
</aside>
<p>If it worked correctly, you should see the app launched within a mock EHR session and you should not have been prompted to enter a username and password.  You should have been prompted to pick a provider and also pick a patient.</p>
<p class="image-container"><img alt="provider picker" src="img/84e323c46d9e569e.png"></p>
<p class="image-container"><img alt="patient picker" src="img/26986307fb35c83a.png"></p>
<p class="image-container"><img alt="launched" src="img/620f529c8692d468.png"></p>
<h3 is-upgraded>Notice</h3>
<p>If you had configured your launch URL to have a pre-selected patient, you would not have seen the patient picker and the patient name listed at the top and bottom edges of the Simulated EHR would have been filled in automatically using that patient; however, the age and gender would not automatically be populated in the form fields.  We must first modify the HTML to do that, which will happen in the next section.</p>
<h2 class="faq" is-upgraded>Frequently Asked Questions</h2>
<h3 is-upgraded>I only see a white screen within the Simulated EHR panel.</h3>
<aside class="warning"><p>You may have visited <a href="https://launch.smarthealthit.org/" target="_blank">https://launch.smarthealthit.org/</a> instead of <a href="http://launch.smarthealthit.org/" target="_blank">http://launch.smarthealthit.org/</a>.  Notice the difference is <code>http</code> versus <code>https</code>.  Try again using <code>http</code> to visit the smart launcher.</p>
</aside>
<h3 is-upgraded>I see an error: localhost sent an invalid response.</h3>
<aside class="warning"><p>You may have entered an <code>https</code>, rather than an <code>http</code>, in your endpoint url.  Try changing it to <code>http</code> and re-launching.</p>
</aside>
<h3 is-upgraded>I was prompted with the original login screen.</h3>
<aside class="warning"><p>Be sure your launch URL includes the full <code>launch.html</code> portion, and not just a path to the webserver root.</p>
</aside>
<h3 is-upgraded>I was not prompted to select either a patient or a provider.</h3>
<aside class="warning"><p>Be sure your launch URL includes the full <code>launch.html</code> portion, and not just a path to the webserver root.  Also confirm that you&#39;re running the <code>v1.0</code> branch of the code (not <code>master</code> or <code>v2.0</code>).</p>
</aside>


      </google-codelab-step>
    
      <google-codelab-step label="Using the SMART Launch Client" duration="20">
        <h2 is-upgraded>Problem</h2>
<aside class="warning"><p>The SMART Launch Framework is now successfully in place!  However, the form HTML needs to be modified in order to take advantage of the EHR context.</p>
</aside>
<h2 is-upgraded>Solution</h2>
<aside class="special"><p>Modify <code>index.html</code> to read context from the SMART Launch client object and apply it to the form.</p>
</aside>
<h2 is-upgraded>EXERCISE 1</h2>
<aside class="special"><p>Modify the following to include the missing pieces of code, which will enable auto-population of the form data from the SMART Launch client object.</p>
<p>Look for all the <code>TODO</code>s in the code and comments below.  You will refer to the documentation often.</p>
<pre><code>&lt;!-- index.html --&gt;
&lt;!DOCTYPE html&gt;
&lt;html&gt;

&lt;head&gt;
  &lt;meta charset=&#34;utf-8&#34;&gt;
  &lt;title&gt;Demo AUC Guidance App&lt;/title&gt;
&lt;/head&gt;

&lt;body&gt;
  &lt;div&gt;
    &lt;form action=&#34;http://localhost:3002/evaluate&#34; method=&#34;POST&#34;&gt;
      &lt;input type=&#34;hidden&#34; id=&#34;provider&#34; name=&#34;provider&#34;&gt;
      &lt;table&gt;
        &lt;caption&gt;Enter Patient Demographics&lt;/caption&gt;
        &lt;tr&gt;
          &lt;th&gt;&lt;label for=&#34;gender&#34;&gt;Gender&lt;/label&gt;&lt;/th&gt;
          &lt;td&gt;
            &lt;select name=&#34;gender&#34; required&gt;
              &lt;option id=&#34;male&#34; value=&#34;male&#34;&gt;Male&lt;/option&gt;
              &lt;option id=&#34;female&#34; value=&#34;female&#34;&gt;Female&lt;/option&gt;
              &lt;option id=&#34;other&#34; value=&#34;other&#34;&gt;Other&lt;/option&gt;
            &lt;/select&gt;
          &lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
          &lt;th&gt;&lt;label for=&#34;age&#34;&gt;Age&lt;/label&gt;&lt;/th&gt;
          &lt;td&gt;&lt;input id=&#34;age&#34; name=&#34;age&#34; required&gt;&lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
          &lt;th&gt;&lt;label for=&#34;indication&#34;&gt;Indication&lt;/label&gt;&lt;/th&gt;
          &lt;td&gt;
            &lt;input list=&#34;indications&#34; name=&#34;indication&#34; required&gt;
            &lt;datalist id=&#34;indications&#34;&gt;
              &lt;option value=&#34;13213009&#34;&gt;congenital heart disease&lt;/option&gt;
              &lt;option value=&#34;25064002&#34;&gt;headache&lt;/option&gt;
              &lt;option value=&#34;279039007&#34;&gt;lower back pain&lt;/option&gt;
              &lt;option value=&#34;423341008&#34;&gt;optic disc edema&lt;/option&gt;
              &lt;option value=&#34;27355003&#34;&gt;toothache&lt;/option&gt;
            &lt;/datalist&gt;
          &lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
          &lt;th&gt;&lt;label for=&#34;procedure&#34;&gt;Procedure&lt;/label&gt;&lt;/th&gt;
          &lt;td&gt;
            &lt;input list=&#34;procedures&#34; name=&#34;procedure&#34; required&gt;
            &lt;datalist id=&#34;procedures&#34;&gt;
              &lt;option value=&#34;75561&#34;&gt;cardiac mri&lt;/option&gt;
              &lt;option value=&#34;70450&#34;&gt;ct scan - no contrast material&lt;/option&gt;
              &lt;option value=&#34;71275&#34;&gt;cta - with contrast material&lt;/option&gt;
              &lt;option value=&#34;72133&#34;&gt;lumbar spine ct scan&lt;/option&gt;
              &lt;option value=&#34;70544&#34;&gt;mra - head&lt;/option&gt;
            &lt;/datalist&gt;
          &lt;/td&gt;
        &lt;/tr&gt;
      &lt;/table&gt;
      &lt;input type=&#34;submit&#34;&gt;
    &lt;/form&gt;
  &lt;/div&gt;

  &lt;!-- TODO: import the fhir-client library here as a module (see the docs).--&gt;

  &lt;script&gt;
    async function getContext(client) {
      return {
        patient: &#39;TODO: read the current patient from the client object&#39;,
        user: &#39;TODO: read the current provider from the client object&#39;,
      };
    }
    function populateForm(context) {
      const patient = context.patient;
      const then = new Date(patient.birthDate),
        now = new Date();
      const msPerYear = 365.25 * 24 * 60 * 60 * 1000;
      const age = (now.getTime() - then.getTime()) / msPerYear;
      document.getElementById(&#39;provider&#39;).value = context.user.id;
      document.getElementById(&#39;age&#39;).value = Math.round(age);
      document.getElementById(patient.gender).setAttribute(&#39;selected&#39;, 1);
    }
    if (typeof FHIR !== &#39;undefined&#39;) {
      FHIR.TODO.call.the.ready.function.here  // Hint: find this in the docs.
        .then(getContext)
        .then(populateForm)
        .catch(console.error);
    }
  &lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p>You may view the solution in <a href="https://github.com/microsoft-healthcare-madison/demo-auc-app/commit/dc28f441558ede38a7464483d2596f2f0e6b07ea#diff-eacf331f0ffc35d4b482f1d15a887d3b" target="_blank">this PR</a>.<br></p>
</aside>
<h2 is-upgraded>EXERCISE 2</h2>
<aside class="warning"><p>Confirm that your changes work by SMART-launching the app from the SMART App Launch portal.  You will know you are complete when the form fields are automatically updated to match the patient you select in the patient picker.</p>
</aside>
<h2 is-upgraded>EXERCISE 3 (BONUS)</h2>
<aside class="special"><p>Now that the app is capable of a SMART Launch, you can remove lots of the session / authentication logic in <code>index.js</code> to simplify things.</p>
<p>Remove the legacy login and authentication code from the existing <code>index.js</code> script.</p>
</aside>
<h2 class="faq" is-upgraded>Frequently Asked Questions</h2>


      </google-codelab-step>
    
      <google-codelab-step label="Write a CDS Hooks Service" duration="90">
        <p>Outline</p>
<ul>
<li>TODO: Show the design goals.</li>
<li>TODO: Link to the CDS Hooks documentation.</li>
<li>TODO: Explain the discovery endpoint.</li>
<li>EXERCISE: Ask user to write a new discovery endpoint.</li>
<li>TODO: Introduce the CDS Hooks Sandbox</li>
<li>EXERCISE: Ask user to add their service in the sandbox.</li>
<li>TODO: Link to the Cards documentation</li>
<li>TODO: Provide the refactored auc.js code.</li>
<li>EXERCIES: Ask user to insert it, removing old code.</li>
<li>TODO: Provide a simple template card</li>
<li>EXERCISE: Add severity &amp; custom icon to the card.</li>
<li>TEST: Ask user to trigger the app by selecting certain criteria in the sandbox.</li>
</ul>
<h2 class="faq" is-upgraded>Frequently Asked Questions</h2>


      </google-codelab-step>
    
      <google-codelab-step label="SMART Web Messaging" duration="60">
        <p>Outline</p>
<ul>
<li>TODO: introduce the design goals (show pictures of the wanted UI).</li>
<li>TODO: link to the documentation.<br><a href="https://github.com/smart-on-fhir/smart-web-messaging" target="_blank">https://github.com/smart-on-fhir/smart-web-messaging</a></li>
<li>EXERCISE: Serialize the draft order, saving into the card.link.appContext</li>
<li>EXERCISE: Ask user to deserialize the draft order in the index.html client context</li>
<li>TODO: Provide the code to update the html using the client context</li>
<li>TODO: Link to the SMART Web Messaging docs</li>
<li>EXERCISE: Ask user to implement the closeApp function using window.postMessage</li>
<li>TODO: provide the code to apply auc logic to the form (the Evaluate button)</li>
<li>EXERCISE: Ask user to implement the updateApp function</li>
<li>TEST: confirm that updates in the launched app update the CDS Hooks sandbox</li>
</ul>
<h2 class="faq" is-upgraded>Frequently Asked Questions</h2>


      </google-codelab-step>
    
      <google-codelab-step label="Bonus Exercies" duration="0">
        <p>These are optional exercises that you are welcome to take on, if you chose.</p>
<h2 is-upgraded><code>auc.js</code></h2>
<p>Update the logic to include more criteria.</p>
<h2 is-upgraded>App Client Refresh</h2>
<p>When the app gets a token from the SMART launch API, that token eventually will timeout.  The UI could give the user an option to request a refresh before it expires, or at least indicate in the UI when the token has expired (with a message like &#34;EHR token has expired - please reload&#34;).</p>
<h2 class="faq" is-upgraded>Frequently Asked Questions</h2>


      </google-codelab-step>
    
      <google-codelab-step label="Codelab Examples" duration="0">
        <h2 class="checklist" is-upgraded>What You&#39;ll Learn</h2>
<ul class="checklist">
<li>How to trigger the special syntax of a codelab, as processed by the <code>claat</code> tool.</li>
<li>What each special feature <em>looks like</em>.<br><br><ul class="checklist">
<li>What You&#39;ll Learn</li>
<li>Tables</li>
<li>Infoboxes</li>
<li>Surveys</li>
<li>Download Button</li>
<li>Embedded iframes</li>
<li>Frequently Asked Questions</li>
<li>What We&#39;ve Covered</li>
</ul>
</li>
</ul>
<p>When you use the magic H3 heading <code>### What You&#39;ll Learn</code> - the following unordered list will be rendered using green checkboxes instead of the default bullet points.</p>
<h3 is-upgraded><code>codelab markdown</code></h3>
<pre><code>### What You&#39;ll Learn
- hi
- there
</code></pre>
<h2 is-upgraded>Tables</h2>
<p>Your codelab can use very simple markdown (or HTML) tables.</p>
<h3 is-upgraded>HTML-based</h3>
<table>
<tr><td colspan="1" rowspan="1"><p>one</p>
</td><td colspan="1" rowspan="1"><p>two</p>
</td><td colspan="1" rowspan="1"><p>nine</p>
</td><td colspan="1" rowspan="1"><p>thirteen</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>three</p>
</td><td colspan="1" rowspan="1"><p>four</p>
</td><td colspan="1" rowspan="1"><p>ten</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>five</p>
</td><td colspan="1" rowspan="1"><p>six</p>
</td><td colspan="1" rowspan="1"><p>eleven</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>seven</p>
</td><td colspan="1" rowspan="1"><p>eight</p>
</td><td colspan="1" rowspan="1"><p>twelve</p>
</td></tr>
</table>
<h3 is-upgraded>Markdown-based</h3>
<table>
<tr></tr>
<tr><td colspan="1" rowspan="1"><p>one</p>
</td><td colspan="1" rowspan="1"><p>two</p>
</td><td colspan="1" rowspan="1"><p>nine</p>
</td><td colspan="1" rowspan="1"><p>thirteen</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>three</p>
</td><td colspan="1" rowspan="1"><p>four</p>
</td><td colspan="1" rowspan="1"><p>ten</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>five</p>
</td><td colspan="1" rowspan="1"><p>six</p>
</td><td colspan="1" rowspan="1"><p>eleven</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>seven</p>
</td><td colspan="1" rowspan="1"><p>eight</p>
</td><td colspan="1" rowspan="1"><p>twelve</p>
</td></tr>
</table>
<h3 is-upgraded><code>codelab markdown</code></h3>
<pre><code>#### HTML-based
&lt;table&gt;
  &lt;tr&gt;&lt;td&gt;one&lt;/td&gt;&lt;td&gt;two&lt;/td&gt;&lt;td&gt;nine&lt;/td&gt;&lt;td&gt;thirteen&lt;/td&gt;&lt;/tr&gt;
  &lt;tr&gt;&lt;td&gt;three&lt;/td&gt;&lt;td&gt;four&lt;/td&gt;&lt;td&gt;ten&lt;/td&gt;&lt;/tr&gt;
  &lt;tr&gt;&lt;td&gt;five&lt;/td&gt;&lt;td&gt;six&lt;/td&gt;&lt;td&gt;eleven&lt;/td&gt;&lt;/tr&gt;
  &lt;tr&gt;&lt;td&gt;seven&lt;/td&gt;&lt;td&gt;eight&lt;/td&gt;&lt;td&gt;twelve&lt;/td&gt;&lt;/tr&gt;
&lt;/table&gt;

#### Markdown-based
|-------|-------|--------|----------|
| one   | two   | nine   | thirteen |
| three | four  | ten    |          |
| five  | six   | eleven |          |
| seven | eight | twelve |          |

</code></pre>
<h2 is-upgraded>Infoboxes</h2>
<p>You can highlight a section of code as either a positive or a negative infobox.</p>
<aside class="special"><p>This is a positive infobox.</p>
</aside>
<aside class="warning"><p>This is a negative infobox.</p>
</aside>
<h3 is-upgraded><code>codelab markdown</code></h3>
<pre><code>&lt;dt&gt;positive&lt;/dt&gt;
&lt;p&gt;This is a positive infobox.&lt;/p&gt;

&lt;dt&gt;negative&lt;/dt&gt;
&lt;p&gt;This is a negative infobox.&lt;/p&gt;
</code></pre>
<h2 is-upgraded>Surveys</h2>
<p>You can include a survey in the codelab which will create Google Analytics variables, which will collect survey response totals.</p>
<google-codelab-survey survey-id="docs-1">
<h4></h4>
<paper-radio-group>
<paper-radio-button>Example item 1</paper-radio-button>
<paper-radio-button>Example item 2</paper-radio-button>
</paper-radio-group>
</google-codelab-survey>
<h3 is-upgraded><code>codelab markdown</code></h3>
<pre><code>&lt;dl&gt;&lt;dt style=&#34;background-color:#cfe2f3;&#34;&gt;Survey&lt;/dt&gt;
&lt;dd&gt;
  &lt;li&gt;Example item 1&lt;/li&gt;
  &lt;li&gt;Example item 2&lt;/li&gt;
&lt;/dd&gt;&lt;/dl&gt;
</code></pre>
<h3 is-upgraded>IMPORTANT!</h3>
<aside class="warning"><p>Unfortunately, the background color value (<code>#cfe2f3</code>) is a <em>magic</em> attribute value.  Without this <em>exact</em> color value, the Survey object will not work as intended.</p>
</aside>
<h2 is-upgraded>Download buttons</h2>
<p>You can create a special button to Download something (like a tagged github repo).<br><a href="https://github.com/microsoft-healthcare-madison/demo-auc-app/archive/v3.0.zip" target="_blank">Download v3.0</a></p>
<aside class="warning"><p>This currently doesn&#39;t work with the <code>claat</code> tool!  Instead the ‘button&#39; is shown as a download link.</p>
</aside>
<h2 is-upgraded>Embedded iframes</h2>
<p>You can embed an iframe in a codelab by setting the <code>alt</code> attribute of an <code>img</code> element.</p>
<h3 is-upgraded>Example: embedded <code>https://glitch.com/~howoldisit</code></h3>
<iframe class="embedded-iframe" src="https://glitch.com/embed/#!/embed/jewel-chevre?path=package.json&previewSize=100"></iframe>
<h3 is-upgraded><code>codelab markdown</code></h3>
<pre><code>![https://glitch.com/embed/#!/embed/jewel-chevre?path=package.json&amp;previewSize=100](Glitch iframe)
</code></pre>
<h2 class="faq" is-upgraded>Frequently Asked Questions</h2>
<ul class="faq">
<li><a href="https://stackoverflow.com/questions/43001894/google-codelab-mistake" target="_blank">https://stackoverflow.com/questions/43001894/google-codelab-mistake</a></li>
<li><a href="https://developer.android.com/courses/fundamentals-training/toc-v2" target="_blank">https://developer.android.com/courses/fundamentals-training/toc-v2</a></li>
</ul>
<p>When linking to stack-overflow (and a few other google-specific URLs) - the link icon is automatically inserted into the link.</p>
<h3 is-upgraded><code>codelab markdown</code></h3>
<pre><code>### Frequently Asked Questions
- &lt;https://stackoverflow.com/questions/43001894/google-codelab-mistake&gt;
- &lt;https://developer.android.com/courses/fundamentals-training/toc-v2&gt;
</code></pre>
<h2 class="checklist" is-upgraded>What We&#39;ve Covered</h2>
<ul class="checklist">
<li>How to trigger the special syntax of a codelab, as processed by the <code>claat</code> tool.</li>
<li>What each special feature <em>looks like</em>.<br><br><ul class="checklist">
<li>What You&#39;ll Learn</li>
<li>Tables</li>
<li>Infoboxes</li>
<li>Surveys</li>
<li>Download Button</li>
<li>Embedded iframes</li>
<li>Frequently Asked Questions</li>
<li>What We&#39;ve Covered</li>
</ul>
</li>
</ul>
<p>When you use the magic H3 heading <code>### What We&#39;ve Covered</code> - the following unordered list will be rendered using green checkboxes instead of the default bullet points.</p>
<h3 is-upgraded><code>codelab markdown</code></h3>
<pre><code>### What We&#39;ve Covered
- good
- bye
</code></pre>


      </google-codelab-step>
    
  </google-codelab>

  <script src="https://storage.googleapis.com/codelab-elements/native-shim.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/custom-elements.min.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/prettify.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/codelab-elements.js"></script>

</body>
</html>
